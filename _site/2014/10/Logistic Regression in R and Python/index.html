<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BADBYE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/badbye.github.com/js/jquery.min.js"></script>
    <script src="/badbye.github.com/js/bootstrap.min.js"></script>
    <link href="/badbye.github.com/css/bootstrap.min.css" rel="stylesheet">
    <link href="/badbye.github.com/css/theme.css" rel="stylesheet">
    <link href="/badbye.github.com/css/pygments.css" rel="stylesheet">


</head>

<body>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/badbye.github.com/">BADBYE</a>
              </div>
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/badbye.github.com/">Home</a></li>
                    <li class="active visible-xs-block"><a href="/badbye.github.com/links.html">Links</a></li>
                    <li class="active"><a href="/badbye.github.com/archive.html">Archive</a></li>
                    <li class="active"><a href="/badbye.github.com/about.html">About</a></li>
                    <li class="active"><a href="/badbye.github.com/feed.xml">RSS</a></li>
                    
                      <li class="active"><a href="https://github.com/badbye/badbye.github.com">Github</a></li>
                    
                </ul>
              </div>
        </div>
    </div>
</div>


<div class="container container-left">
    <div class="row">
        <div class="col-md-3 hidden-xs">
            <div class="sidebar well">
Welcome to my blog!
</div>

<div class="sidebar well" id = "recentPosts">
    <h1>Recent Posts</h1>
    <ul>
        
          <li><a href="/badbye.github.com/2015/04/Rmd2pdf">Rmd到PDF的转换</a></li>
        
          <li><a href="/badbye.github.com/2014/10/Logistic%20Regression%20in%20R%20and%20Python">Logistic Regression in R and Python</a></li>
        
          <li><a href="/badbye.github.com/2013/11/%E9%9D%9E%E5%8F%82%E6%95%B0%E7%BB%9F%E8%AE%A1">非参数统计</a></li>
        
          <li><a href="/badbye.github.com/2013/11/%E7%AC%AC%E5%85%AD%E5%B1%8AR%E8%AF%AD%E8%A8%80%E4%BC%9A%E8%AE%AE%E8%AE%B0%E4%BA%8B">第六届R语言会议记事</a></li>
        
          <li><a href="/badbye.github.com/2013/09/$R%5E2$%E5%A6%82%E4%BD%95%E5%B0%8F%E4%BA%8E0%EF%BC%9F">$R^2$如何小于0？</a></li>
        
    </ul>
</div>

<div class="sidebar well" id="links">
<h1>Links</h1>
<ul>
  <li><a href="#">One</a></li>
  <li><a href="#">Two</a></li>
  <li><a href="#">Three</a></li>
  <li><a href="#">Four</a></li>
</ul>

</div>

        </div>
        <div class="col-md-9">
          <div class="article">
            <div class="well">
                <h1><a href="/badbye.github.com/2014/10/Logistic%20Regression%20in%20R%20and%20Python">Oct 29, 2014 - Logistic Regression in R and Python</a></h1>
<!--              
                <p class="author"><a href="#disqus_thread">Comments</a></p>
             -->
            <div class="post-content">
            <p>python中的scikit-learn库提供了一系列机器学习的算法，其中包括Logistic Regression。不过默认的，该库提供的是加入L2惩罚项的Logistic回归。但是程序设置上，python与R语言中有点出入，使得默认设置下同样数据出现的结果相差很大。</p>

<h2 id="r语言">R语言</h2>

<p>在R语言中执行带惩罚项的Logistic回归，需要加载glmnet包。包中Logistic回归的优化目标是：</p>

<p>$$L(\theta)_R = -\frac{\text{log likelihood}}{\text{nobs}} + \lambda * \text{penalty}$$</p>

<p>其中$\text{nobs}$代表样本量。惩罚项如果是L2惩罚，则是$\frac{1}{2} \parallel \theta \parallel_2^2$，其中不包含截距项。如果是L1惩罚，就是$|\theta|_1$.</p>

<p>glmnet的设置：</p>

<ul>
<li>family=‘binomial’ 代表Logistic回归;</li>
<li>alpha 表示elasticnet的混合参数：</li>
</ul>

<p>$$\frac{1-\alpha}{2} \parallel \theta \parallel_2^2 + \alpha |\theta|_1$$</p>

<p>所以$\alpha=1$表示lasso的L1惩罚，$\alpha=0$表示岭回归的L2惩罚;
lambda 就是优化目标中的参数λ
默认的，glmnet会添加截距项，并对自变量进行标准化。</p>

<h2 id="python">python</h2>

<p>python的scikit-learn中，Logistic回归是参考的<a href="http://www.csie.ntu.edu.tw/%7Ecjlin/papers/maxent_dual.pdf">这篇文献</a>。文献中二阶惩罚优化的目标函数是：</p>

<p>$$L(\theta) = -C*\text{log likelihood} + \frac{1}{2}\parallel \theta \parallel_2^2$$</p>

<p>与R语言的区别在于，这里的惩罚项里包含截距项。另外参数设置上，这里的$C$相当于$\lambda$，都是作为一个权衡似然函数和惩罚项的参数。</p>

<p>若想要与R语言的优化目标一致，则需要满足：</p>

<ul>
<li>不含截距项</li>
<li>$n\lambda = \frac{1}{C}$</li>
</ul>

<p>其中，$n$表示样本量，$\lambda$是R语言glmnet函数中的<em>lambda</em>参数，$C$是python中的参数。</p>

<h2 id="code">Code</h2>

<p>选择iris数据的前100行，作一个二分类的Logistic回归。设置python中$C=1$，R语言中应该有$n\lambda=1$，所以<em>lambda</em>应该是$\frac{1}{n}=0.01$。</p>

<h3 id="无截距项">无截距项</h3>

<p>python：无截距项</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="n">iris</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_iris</span><span class="p">()</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span> <span class="o">!=</span> <span class="mi">2</span>
<span class="n">logit</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">logit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">],</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="k">print</span> <span class="p">[</span><span class="n">logit</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="n">logit</span><span class="o">.</span><span class="n">intercept_</span><span class="p">]</span></code></pre></div>
<div class="highlight"><pre><code class="language-text" data-lang="text">[array([[-0.44234418, -1.48544863,  2.23987714,  1.01147778]]), 0.0]
</code></pre></div>
<p>R语言：无截距，不标准化</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>glmnet<span class="p">)</span>
index <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">100</span>
iris.x <span class="o">=</span> <span class="kp">as.matrix</span><span class="p">(</span>iris<span class="p">[</span>index<span class="p">,</span> <span class="m">1</span><span class="o">:</span><span class="m">4</span><span class="p">])</span>
iris.y <span class="o">=</span> <span class="kp">as.factor</span><span class="p">(</span><span class="kp">as.character</span><span class="p">(</span>iris<span class="p">[</span>index<span class="p">,</span> <span class="m">5</span><span class="p">]))</span>
<span class="c1"># 不标准化自变量，不添加截距项</span>
logit <span class="o">=</span> glmnet<span class="p">(</span>iris.x<span class="p">,</span> iris.y<span class="p">,</span> family<span class="o">=</span><span class="s">&quot;binomial&quot;</span><span class="p">,</span> alpha<span class="o">=</span><span class="m">0</span><span class="p">,</span> lambda<span class="o">=</span><span class="m">1</span><span class="o">/</span><span class="m">100</span><span class="p">,</span> standardize<span class="o">=</span><span class="bp">F</span><span class="p">,</span> thresh <span class="o">=</span><span class="m">1e-8</span><span class="p">,</span> intercept <span class="o">=</span> <span class="bp">F</span><span class="p">)</span>
coef<span class="p">(</span>logit<span class="p">)</span></code></pre></div>
<div class="highlight"><pre><code class="language-text" data-lang="text">5 x 1 sparse Matrix of class &quot;dgCMatrix&quot;
                     s0
(Intercept)   .        
Sepal.Length -0.4385104
Sepal.Width  -1.4868544
Petal.Length  2.2384771
Petal.Width   1.0031797
</code></pre></div>
<p>结果基本一致。</p>

<h3 id="添加截距项？">添加截距项？</h3>

<p>最后，若想添加截距项后两个程序结果一致，可以修改python中的<code>intercept_scaling</code>参数，其参数解释为：</p>

<blockquote>
<p>when self.fit_intercept is True, instance vector x becomes [x, self.intercept_scaling], i.e. a “synthetic” feature with constant value equals to intercept_scaling is appended to the instance vector. The intercept becomes intercept_scaling * synthetic feature weight Note! the synthetic feature weight is subject to l1/l2 regularization as all other features. To lessen the effect of regularization on synthetic feature weight (and therefore on the intercept) intercept_scaling has to be increased.</p>
</blockquote>

<p>具体的计算原理不清楚，但依据解释，只要增大<code>intercept_scaling</code>就可以减少惩罚项对截距的影响。</p>

<p>先来看看python中添加截距项的默认结果：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">logit</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">logit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">],</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="k">print</span> <span class="p">[</span><span class="n">logit</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="n">logit</span><span class="o">.</span><span class="n">intercept_</span><span class="p">]</span></code></pre></div>
<div class="highlight"><pre><code class="language-text" data-lang="text">[array([[-0.4070443 , -1.46126494,  2.23984278,  1.00849909]]), array([-0.26042082])]
</code></pre></div>
<p>增大intercept_scaling=100000的结果：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">logit</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">intercept_scaling</span><span class="o">=</span><span class="mf">1e5</span><span class="p">)</span>
<span class="n">logit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">],</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="k">print</span> <span class="p">[</span><span class="n">logit</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="n">logit</span><span class="o">.</span><span class="n">intercept_</span><span class="p">]</span></code></pre></div>
<div class="highlight"><pre><code class="language-text" data-lang="text">[array([[-0.44234418, -1.48544863,  2.23987714,  1.01147778]]), 0.0]
</code></pre></div>
<p>R语言中添加截距项的结果：</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">logit <span class="o">=</span> glmnet<span class="p">(</span>iris.x<span class="p">,</span> iris.y<span class="p">,</span> family<span class="o">=</span><span class="s">&quot;binomial&quot;</span><span class="p">,</span> alpha<span class="o">=</span><span class="m">0</span><span class="p">,</span> lambda<span class="o">=</span><span class="m">1</span><span class="o">/</span><span class="m">100</span><span class="p">,</span> 
               standardize<span class="o">=</span><span class="bp">F</span><span class="p">,</span> thresh <span class="o">=</span> <span class="m">1e-8</span><span class="p">,</span> intercept <span class="o">=</span> <span class="bp">T</span><span class="p">)</span>
coef<span class="p">(</span>logit<span class="p">)</span></code></pre></div>
<div class="highlight"><pre><code class="language-text" data-lang="text">5 x 1 sparse Matrix of class &quot;dgCMatrix&quot;
                     s0
(Intercept)  -6.6114025
Sepal.Length  0.4403477
Sepal.Width  -0.9070024
Petal.Length  2.3084749
Petal.Width   0.9623247
</code></pre></div>
<p>增大<code>intercept_scaling=100000</code>后与R语言的结果基本一致了。</p>

            </div>

             <div class="pagination" style="clear:both;">
              
                <div style="float: left; display:inline-block">下一篇: <a class="btn btn-default" href="/badbye.github.com/2015/04/Rmd2pdf" class="next">Rmd到PDF的转换</a>
                </div>
              
            <div>
              
                <div style="float: right; display:inline-block">上一篇: <a class="btn btn-default" href="/badbye.github.com/2013/11/%E9%9D%9E%E5%8F%82%E6%95%B0%E7%BB%9F%E8%AE%A1" class="previous">非参数统计</a>
                </div>
              
            </div>
            </div>

              
              <div class="ds-thread" data-thread-key="/2014/10/Logistic Regression in R and Python" data-title="Logistic Regression in R and Python" data-url="http://badbye.github.io//2014/10/Logistic%20Regression%20in%20R%20and%20Python">
  <script type="text/javascript">
    var duoshuoQuery = {short_name:'yalei'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
</div>
              
            </div>
          </div>


        </div>
    </div>
</div>

<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/x-mathjax-config">
/*js file to load mathJax*/
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
           extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });

  MathJax.Hub.Queue(function() {
      // Fix <code> tags after MathJax finishes running. This is a
      // hack to overcome a shortcoming of Markdown. Discussion at
      // https://github.com/mojombo/jekyll/issues/199
      var all = MathJax.Hub.getAllJax(), i;
      for(i = 0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12 footer navbar-inverse navbar-fixed-bottom">
            <p class="copyright">&copy;2015 BADBYE. Powered by <a href="http://jekyllrb.com">Jekyll</a>, theme by <a href="https://github.com/scotte/jekyll-clean">Scott Emmons</a>
            under
            <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution</a></p>
        </div>
    </div>
</div>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63950333-1', 'auto');
  ga('send', 'pageview');

  </script>



</body>
</html>

